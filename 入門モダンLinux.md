# 1 Linuxの入門

# 2 Linuxカーネル

システムコール: ユーザプログラムからOSの機能を利用するためのインターフェース

カーネルはモノリシック

主なコンポーネントは

* プロセス管理
* メモリ管理
* ファイルシステム
* ネットワーク
* デバイスドライバ

## プロセス管理

次のような概念がある

* セッション
  * 複数のプロセスグループを含む。ttyを持つ。SIDで識別
* プロセスグループ
  * 複数のプロセスを含む。PGIDで識別
* プロセス
  * プログラムの実行に必要なリソースをグループ化したもの
* スレッド
  * カーネルではプロセスと同じ扱い
* タスク
  * スケジューリング関連の情報PIDなど,nice値などを持つ

## メモリ管理

物理メモリ、仮想メモリともにチャンクに分割されている

プロセスごとにページテーブルがあり、仮想アドレスと物理アドレスの対応を管理する

オーバーコミットにより物理メモリサイズ以上のメモリ確保が可能で、物理メモリ領域の割当は遅延して行われる

仮想アドレスと物理アドレスの対応はTLBにキャッシュされる

Hugepage: ページサイズを大きくすることでTLBのヒット率を上げる

## ネットワーク

* ソケット：通信を抽象化したもの
* TCP/UDP
* IP

カーネルが提供するのは上記のみ

## ファイルシステム

ext4,btrfs,etc...

VFS: ファイルシステムを抽象化して異なるファイルシステムが共存できるように導入されている

## デバイスドライバ

キーボード、マウス、HDDなどのハードウェア、/dev/pts配下の仮想デバイスを制御

`ls -al /sys/devices`でシステム上のデバイスが確認可能

## システムコール

glibcなどがラッパーライブラリ

カーネルモードとユーザ空間の切り替えはコストがかかる

`strace`で確認可能

## カーネルの拡張

### モジュール

必要に応じてカーネルにロードできるプログラム

ハードウェアを自動検出して自動的にロードしてくれることがほとんど

手動でモジュールを読み込みたいときは、ベンダが提供しているモジュールを読み込むなど

ロードしているモジュールは`lsmod`で確認可能

### eBPF

カーネル機能を拡張する手段

セキュリティコントロール、ネットワークロードバランシングなどで利用されている

# 3 シェルとスクリプト

## 用語

### ターミナル

CUIベースのUIを提供するプログラム

### シェル

ターミナル内で動作するコマンドインタプリタとして機能するプログラム

#### ストリーム

入力ストリームと出力ストリームがある

#### 変数

環境変数とシェル変数がある

シェル変数は実行中のシェルのみで有効。例えばシェルが起動する子プロセスには継承されない

#### 終了ステータス

一般的に0は成功、それ以外の1-255は失敗を表す

シェルを閉じたあともバックグラウンドプロセスを動作させたいときは`nohup`,すでに動作しているものに同様のことをしたい場合は`disown`を使う

ターミナルマルチプレクサを使うと、ターミナルを閉じてもバックグラウンドプロセスを動作させることができる

よく使うコマンドは最小限の労力で。aliasを使うとよい

## ターミナルマルチプレクサ

ターミナル内で複数のターミナルを開くことができる

## スクリプト

スクリプトを書くならbashでよい

規模がでかそうならpython,rubyなどを検討する

### 移植性の高いbashスクリプトの書き方

shebangと実行権限を付与する

以下のオプションはつけるべき


```
set -o errexit
set -o nounset
set -o pipefail
```

bashはデフォルトエラーメッセージを出さずに失敗する傾向があるので速やかに失敗すること

インラインドキュメントの整備

80カラム幅にする

linterのデファクトはshellcheck
